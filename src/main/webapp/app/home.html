<!DOCTYPE html>
<html>
<head>
  <title>Deposit Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <!-- <meta name="theme-color" content="#7952b3"> -->

  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="./dist/bootstrap.css">
  <!-- <link rel="stylesheet" href="./dist/font/fontawesome-free.min.css"> -->
  <link rel="stylesheet" href="./dist/bootstrap-icons.css">
  <link rel="stylesheet" href="./dist/icheck-bootstrap.min.css">
  <link rel="stylesheet" href="./dist/ag-theme-alpine.css">
  <link rel="stylesheet" href="./dist/jquery/menu/jquery.contextMenu.css">
  <link rel="stylesheet" href="./dist/daterangepicker.css">
  <link rel="stylesheet" href="./dist/toastr.min.css">

  <link rel="stylesheet" href="./app/dashboard.css">

  <script src="./dist/jquery-3.5.1.min.js"></script>
</head>

<body style="overflow: hidden;">
  <!-- style="background-image: linear-gradient(to right, #212529, #212529, #212529, #343a40, #212529, #212529);" -->
   <!-- background-image: linear-gradient(to right, #212529, #495057, #495057); -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="padding: 0 0 0 5px; background: linear-gradient(to right, #212529, #212529, #198754, #212529);">
    <a href="#" class="navbar-brand"><img src="img/natlib-logo-orange.png" width="35" height="35">&nbsp;Deposit&nbsp;Dashboard</a>
    <form class="d-flex">
      <input id="filter-deposit-job" class="form-control me-2" type="search" placeholder="Filter" aria-label="Search">
    </form>

    <ul class="navbar-nav me-auto mb-2 mb-md-0">
      <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#search-deposit-job"><i class="bi bi-search"></i>&nbsp;Search</button>
      <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#new-manual-deposit-job"><i class="bi bi-plus-circle"></i>&nbsp;New Deposit</button>
    </ul>

    <ul class="navbar-nav bg-success" id="control-right">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-bs-toggle="dropdown" aria-expanded="false">Signed in as ${userName} <br/> <i class="bi bi-person"></i>&nbsp;Admin</a>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end bg-danger" aria-labelledby="dropdown01">
          <li><a class="dropdown-item" href="#" onclick="signOut();"><i class="bi bi-power"></i>&nbsp;Sign out</a></li>
        </ul>
      </li>
    </ul>

    <ul class="navbar-nav bg-gradient">
      <li class="nav-item">
        <!-- <a class="nav-link" href="#" onclick="javascript: togglePanelSetting();">Settings <br/> <i class="bi bi-gear"></i></a> -->
        <a class="nav-link" href="#" onclick="openModalSettings();">Settings <br/> <i class="bi bi-gear"></i></a>
      </li>
    </ul>
</nav>

<main style="display: none;">
  <div class="ag-theme-alpine-dark" id="grid-deposit-jobs"></div>
</main>

<!-- <div id="panelSetting"></div> -->
  ${templateSettingGlobal}

<div id="modal-sso-login" style="display: none;"></div>

<div class="modal fade" id="modal-global-setting-initial" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">Congrats! Login succeed!</h5>
      </div>
      <div class="modal-body">
        <h4>This is the first time to use the dashboard. You MUST initial the dashboard before using it. If you agree, the current user <span class="text-primary">[${userName}]</span> will be add to the white list as an admin user.</h4>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="initialGlobalSetting();">Initial</button>
        <button type="button" class="btn btn-secondary" onclick="signOut();">Sign out</button>
      </div>
    </div>
  </div>
</div>

${templateDepositJobs}

${templateSettingFlows}

<script src="./dist/bootstrap.bundle.js"></script>
<script src="./dist/ag-grid-community.min.js"></script>
<script src="./dist/jquery/menu/jquery.contextMenu.js"></script>
<script src="./dist/jquery/menu/jquery.ui.position.js"></script>
<script src="./dist/plugins/moment-with-locales.min.js"></script>
<script src="./dist/daterangepicker.js"></script>
<script src="./dist/toastr.min.js"></script>

<script src="./app/dashboard.js"></script>
<script src="./app/deposit-jobs.js"></script>
<script src="./app/setting-flows.js"></script>
<script src="./app/setting-global.js"></script>

<#list map_path_constants as key, value>
<script>
  const ${key}='${PATH_CONTEXT}' + '${value}';
</script>
</#list>

<script>
  const HTML_IFRAME_LOGIN='<iframe src="${redirectUrl}" scrolling="no" frameborder="0" allowfullscreen> </iframe>';
  const IS_GLOBAL_SETTING_INITIALED=${initialed};
  const modalGlobalSettingInitial = new bootstrap.Modal(document.getElementById('modal-global-setting-initial'), {keyboard: false});
  const modalSettings = new bootstrap.Modal(document.getElementById('modal-settings'), {keyboard: false});


  function openModalSettings(){
    fetchHttp(PATH_SETTING_GLOBAL_GET, null, function(rsp){
        var globalSetting=rsp['globalSetting'];
        $('#global-setting input[name="depositUserInstitute"]').val(globalSetting['depositUserInstitute']);
        $('#global-setting input[name="depositUserName"]').val(globalSetting['depositUserName']);
        $('#global-setting input[name="depositUserPassword"]').val(globalSetting['depositUserPassword']);

        if (globalSetting.auditRst) {
            $('#modal-global-setting-pop div[name="audit"]').hide();
        }else{
            $('#modal-global-setting-pop div[name="audit"]').show();
            $('#modal-global-setting-pop div[name="audit"]').html('<i class="bi bi-exclamation-triangle-fill text-danger">&nbsp;</i>' + globalSetting.auditMsg);
        }

        tableWhiteList.setRowData(rsp['whiteList']);
        tableFlowSettings.setRowData(rsp['flowSettings']);

        modalSettings.show();
    });
  }

  function loginCallback(){
    $('#modal-sso-login').hide();
    $('#modal-sso-login').html('');
    fetchHttp(retryUrl, retryReq, retryCallback);
  }

  function isParentAvailable(){
    return true;
  }

  function popupSSOLoginWindow(){    
    $('#modal-sso-login').html(HTML_IFRAME_LOGIN);
    $('#modal-sso-login').show();
  }

  function signOut(){
    window.location.replace(PATH_USER_LOGOUT);
  }

  function initialGlobalSetting(){
    fetchHttp(PATH_SETTING_GLOBAL_INITIAL, null, function(rsp){
      window.location.replace('${PATH_CONTEXT}');
    });
  }

  $(function(){
      toastr.options=Object.assign(toastr.options,{
        "positionClass": "toast-top-center",
        "closeButton": true,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
      });

      if (IS_GLOBAL_SETTING_INITIALED) {
        $('main').show();
        initDepositJob();
        initFlowSettings();
      }else{
        modalGlobalSettingInitial.show();
      }
  });
</script>
</body>
</html>
